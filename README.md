Enhanced code from v1
